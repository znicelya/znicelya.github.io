{"title":"word文档转换","uid":"4f98b553987c19a3aa733b73b56290b0","text":"word文档转换最近公司业务需求要把HTML和word文档互相转换，经过技术选型之后最终决定使用Apache POI（主要因为其他现有解决方案收费），记录一下 Maven &lt;dependency&gt; &lt;groupId&gt;org.htmlparser&lt;&#...","date":"2022-02-05T09:22:11.000Z","updated":"2022-02-12T03:57:36.873Z","comments":true,"path":"api/pages/bak/word文档转换.json","covers":"https://imgapi.cn/api.php?zd=zsy&fl=fengjing&gs=images","excerpt":"","content":"<h1 id=\"word文档转换\"><a href=\"#word文档转换\" class=\"headerlink\" title=\"word文档转换\"></a>word文档转换</h1><p>最近公司业务需求要把HTML和word文档互相转换，经过技术选型之后最终决定使用Apache POI（主要因为其他现有解决方案收费），记录一下</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>Maven</p></blockquote>\n<pre class=\"line-numbers language-xml\" data-language=\"xml\"><code class=\"language-xml\">&lt;dependency&gt;\n    &lt;groupId&gt;org.htmlparser&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;htmlparser&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;1.6&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.poi&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;poi&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;4.0.1&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.poi&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;poi-ooxml&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;4.0.1&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;fr.opensagres.xdocreport&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;fr.opensagres.poi.xwpf.converter.core&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;2.0.2&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;fr.opensagres.xdocreport&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;fr.opensagres.poi.xwpf.converter.xhtml&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;2.0.2&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.poi&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;poi-scratchpad&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;4.0.1&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;</code></pre>\n\n<h2 id=\"HTML转DOCX\"><a href=\"#HTML转DOCX\" class=\"headerlink\" title=\"HTML转DOCX\"></a>HTML转DOCX</h2><p>HTML转换为docx需要借助<code>htmlparser</code>来解析html结构</p>\n<p>下面粘上代码</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; 获取解析对象\nParser parser &#x3D; Parser.createParser(html, &quot;utf-8&quot;);\n&#x2F;&#x2F; 创建文档对象\nXWPFDocument document &#x3D; new XWPFDocument();\n&#x2F;&#x2F; 创建标签过滤器\nTagNameFilter pFilter &#x3D; new TagNameFilter(&quot;p&quot;);\n&#x2F;&#x2F; 解析 过滤器 得到节点列表\nNodeList nodeList &#x3D; parser.parse(pFilter);</code></pre>\n\n<p>这样就拿到了所有的P标签（约定所有的元素都在P标签内）</p>\n<p>之后遍历所有的P元素向文档里面添加</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">for (int i &#x3D; 0; i &lt; nodeList.size(); i++) &#123;\n    &#x2F;&#x2F; 拿到普通 P 节点\n    ParagraphTag pNode &#x3D; (ParagraphTag) normalNodes.elementAt(i);\n    &#x2F;&#x2F; 建立word段落\n\tXWPFParagraph paragraph &#x3D; document.createParagraph();\n    &#x2F;&#x2F; 拿到P标签的所有子节点\n    NodeList pChildNodes &#x3D; pNode.getChildren();\n    if (pChildNodes !&#x3D; null) &#123;\n        &#x2F;&#x2F; 遍历P节点的子节点\n        for (int i1 &#x3D; 0; i1 &lt; pChildNodes.size(); i1++) &#123;\n            &#x2F;&#x2F; 创建 行\n            XWPFRun run &#x3D; paragraph.createRun();\n            Node node1 &#x3D; pChildNodes.elementAt(i1);\n            &#x2F;&#x2F; 文本节点\n            if (node1 instanceof TextNode)&#123;\n                if (StringUtils.isBlank(node1.toPlainTextString()))&#123;\n                    continue;\n                &#125;\n                run.setText(node1.toPlainTextString());\n                continue;\n            &#125;\n            &#x2F;&#x2F; 非文本 节点\n            TagNode spanNode &#x3D; (TagNode) pChildNodes.elementAt(i1);\n            &#x2F;&#x2F; 拿到 span style\n            String styleText &#x3D; spanNode.getAttribute(&quot;style&quot;);\n            &#x2F;&#x2F; ... 设置样式 ...\n            run &#x3D; paragraph.createRun();\n            &#x2F;&#x2F; 将 span节点内容写入 word\n            run.setText(spanNode.toPlainTextString());\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>经过上面的操作就可以把一个简单的HTML文件转换为docx格式的word文档了</p>\n<p>ps ： <strong>注意这样只能解析固定格式的HTML，如果要解析复杂格式则需要递归进行控制</strong></p>\n<p>这里贴上尾注操作方式</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public static void addEndNote(XWPFDocument document, XWPFParagraph paragraph, String content, TagNode tagNode, ParagraphTag paragraphTag) &#123;\n    XWPFRun run &#x3D; paragraph.createRun();\n    CTFtnEdnRef fr &#x3D; run.getCTR().addNewEndnoteReference();\n    fr.setId(BigInteger.ONE);\n    document.createEndnotes();\n    CTFtnEdn ctNote &#x3D; CTFtnEdn.Factory.newInstance();\n    ctNote.setId(BigInteger.ONE);\n    ctNote.setType(STFtnEdn.NORMAL);\n    CTP ctp &#x3D; ctNote.addNewP();\n    XWPFParagraph p2 &#x3D; new XWPFParagraph(ctp, document);\n    run &#x3D; p2.createRun();\n    run.getCTR().addNewEndnoteRef();\n    CTText ctText &#x3D; run.getCTR().addNewT();\n    ctText.setStringValue(&quot; &quot;);\n    ctText.setSpace(SpaceAttribute.Space.PRESERVE);\n    run.setText(content);\n    htmlToDocX.setTextRunStyle(paragraph, run, tagNode, paragraphTag);\n    document.addEndnote(ctNote);\n&#125;</code></pre>\n\n<p>脚注与尾注添加方式类似，只需稍作调整就可以</p>\n<p>目录实现可以参考</p>\n<p><a href=\"https://www.jianshu.com/p/0a32d8bd6878\">Apache POI自动生成Word文档（带目录）</a></p>\n<h2 id=\"DOCX转HTML\"><a href=\"#DOCX转HTML\" class=\"headerlink\" title=\"DOCX转HTML\"></a>DOCX转HTML</h2><p>DOCX转HTML则相对来说比较简单，POI内部对其做了实现</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; 1) 加载word文档生成 XWPFDocument对象\nInputStream in &#x3D; new FileInputStream(word);\nXWPFDocument document &#x3D; new XWPFDocument(in);\nXHTMLOptions options &#x3D; XHTMLOptions.create();\noptions.setOmitHeaderFooterPages(true);\noptions.setIgnoreStylesIfUnused(false);\noptions.setFragment(true);\n&#x2F;&#x2F; base64 图片\noptions.setImageManager(new Base64EmbedImgManager());\n&#x2F;&#x2F; 也可以使用字符数组流获取解析的内容\nByteArrayOutputStream baos &#x3D; new ByteArrayOutputStream();\nXHTMLConverter.getInstance().convert(document, baos, options);\n&#x2F;&#x2F; HTML内容\nString content &#x3D; baos.toString();\nbaos.close();\nin.close();</code></pre>\n\n<p><strong>ps: 这种方式有个缺陷就是尾注，脚注会丢失 需要自己手动去实现</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; 获取所有尾注内容 及其索引\npublic static List&lt;Map&lt;Integer, String&gt;&gt; readEndNote(XWPFDocument document) throws Exception&#123;\n    List&lt;Map&lt;Integer,String&gt;&gt; maps &#x3D; new ArrayList&lt;&gt;();\n    List&lt;XWPFEndnote&gt; endnotes &#x3D; document.getEndnotes();\n    for (XWPFEndnote endnote : endnotes) &#123;\n        Map&lt;Integer,String&gt; map &#x3D; new HashMap&lt;&gt;();\n        Iterator&lt;XWPFParagraph&gt; iterator &#x3D; endnote.iterator();\n        while (iterator.hasNext()) &#123;\n            String text &#x3D; iterator.next().getText();\n            if (endnote.getId() !&#x3D; null &amp;&amp; StringUtils.isNotBlank(text))&#123;\n                map.put(endnote.getId().intValue(), text);\n                maps.add(map);\n            &#125;\n        &#125;\n    &#125;\n    return maps;\n&#125;</code></pre>\n\n<p>上面拿到了文档的所有尾注</p>\n<p>但是我们没有办法去得到尾注应该出现的位置，最后详细阅读POI这一块的源码实现之后手动修改一部分使其支持转换</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">XWPFDocumentVisitor.visitRun()\n&#x2F;&#x2F; 在这个方法里面添加\nList&lt;Map&lt;Integer, String&gt;&gt; maps &#x3D; readEndNote(run.getDocument());\nList&lt;CTFtnEdnRef&gt; endnoteReferenceList &#x3D; ctr.getEndnoteReferenceList();\nif (endnoteReferenceList.size() &gt; 0) &#123;\n    List&lt;XWPFEndnote&gt; endnotes &#x3D; run.getDocument().getEndnotes();\n    for (CTFtnEdnRef ctFtnEdnRef : endnoteReferenceList) &#123;\n        for (XWPFEndnote endnote : endnotes) &#123;\n            for (Map&lt;Integer, String&gt; map : maps) &#123;\n                for (Map.Entry&lt;Integer, String&gt; entry : map.entrySet()) &#123;\n                    if (map.get(endnote.getId().intValue()) !&#x3D; null\n                        &amp;&amp; endnote.getId().intValue() &#x3D;&#x3D; entry.getKey()\n                        &amp;&amp; ctFtnEdnRef.getId().intValue() &#x3D;&#x3D; endnote.getId().intValue()) &#123;\n                        &#x2F;&#x2F; Nicely定义 写出尾注\n                        &#x2F;&#x2F; 此方法需自己定义\n                        visitEndNote(entry.getValue());\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nXHTMLMapper.class\n&#x2F;&#x2F; 此方法在XWPFDocumentVisitor定义 在XHTMLMapper中实现\npublic void visitEndNote(String content) throws Exception&#123;\n    AttributesImpl attributes &#x3D; new AttributesImpl();\n    &#x2F;&#x2F; 为其添加class\n    SAXHelper.addAttrValue(attributes, CLASS_ATTR, &quot;endNote&quot;);\n    &#x2F;&#x2F; 添加样式\n    SAXHelper.addAttrValue(attributes, STYLE_ATTR, &quot;color:red&quot;);\n    startElement(P_ELEMENT,attributes);\n    characters(StringEscapeUtils.escapeHtml(content));\n    endElement(P_ELEMENT);\n&#125;</code></pre>\n\n<p>经过上面处理后大致为下图所示</p>\n<p><img src=\"https://gitee.com/zniceya/picgo/raw/master/image/20211115200857.png\" alt=\"image-20211115200850549\"></p>\n<p>这时候需要用JS来控制其显示方式，将其放到尾部</p>\n","count_time":{"symbolsCount":"7.5k","symbolsTime":"7 mins."},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#word%E6%96%87%E6%A1%A3%E8%BD%AC%E6%8D%A2\"><span class=\"toc-text\">word文档转换</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#HTML%E8%BD%ACDOCX\"><span class=\"toc-text\">HTML转DOCX</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#DOCX%E8%BD%ACHTML\"><span class=\"toc-text\">DOCX转HTML</span></a></li></ol></li></ol>"}